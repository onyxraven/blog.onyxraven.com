
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Local/Server synchronization with Ruby and FSEvent - OnyxRaven</title>
  <meta name="author" content="Justin Hart">

  
  <meta name="description" content="A lot of the work I do is PHP/html type coding. I try to keep a local setup that is able to run all of my code without too much trouble, but &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://onyxraven.github.io/blog/2011/10/02/sync-ruby-fsevent/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="OnyxRaven" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Dosis:400,700|PT+Sans:400,700,400italic,700italic|PT+Serif:400,700,400italic,700italic|Exo+2:400,400italic,700,700italic|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">OnyxRaven</a></h1>
  
    <h2>OnyxRaven's Blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:onyxraven.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Local/Server Synchronization With Ruby and FSEvent</h1>
      
    

    
      <p class="meta">
        








  


<time datetime="2011-10-02T03:12:00-06:00" pubdate data-updated="true">Oct 2<span>nd</span>, 2011</time>
        
      </p>
    
  </header>



<div class="entry-content"><p>A lot of the work I do is PHP/html type coding. I try to keep a local setup that is able to run all of my code without too much trouble, but eventually all that code has to be tested on something resembling the production environment, or there are certain functions that can only be performed there (say, handling NFS mounts, or attaching to databases otherwise firewalled on my local machine). In those situations, I need to be able to quickly copy my code from my local machine to the development server. I used to do this manually, but the cycle of edit-save-copy-test was really annoying. Aptana and Eclipse have some tools that help, but I don&rsquo;t use those tools anymore day-to-day, and they seemed to always get messed up.</p>

<p>I took while to find a suitable setup for keeping files in sync like this. Somehow I came across doubledown, a ruby script using the OSX FSEvent framework. For whatever reason, I couldn&rsquo;t quite make it work on my machine (YMMV), so I took the idea and searched for other uses of FSEvent out there. I came across a few rubygems wrapping FSEvent nicely, and wrote a script around that. First, you&rsquo;ll probably want to set up ssh keys. This will let you rsync over ssh without having to log in every time (kind of important on this one). I don&rsquo;t like the idea of having keys that don&rsquo;t have a password, so I use keychain to manage my keys. In my ~/.zshrc I have the following snippet:</p>

<div><script src='https://gist.github.com/4366205.js'></script>
<noscript><pre><code>w=`echo &quot;($RANDOM % 499) * 100000000000000000&quot; | bc -lws`; sleep $w
keychain --attempts 3 --lockwait 60 -q $HOME/.ssh/github_rsa $HOME/.ssh/onyx_dsa
if [ -f $HOME/.keychain/$HOST-sh ]; then
    source $HOME/.keychain/$HOST-sh
else
    echo &quot;No keychain for $HOST&quot;;
fi
</code></pre></noscript></div>


<p>The random delay lets me launch more than one shell at a time (my default windowgroup in Terminal.app is has two) without conflict.</p>

<p>Second, you&rsquo;ll want to have a way to fully-sync your directories. The following script does this with a single command, and with some options provided by gnu getopt. The biggest features are a preset source/destination (which can be appended), and skipping .svn/.hg directories. In a rush, skipping those makes a HUGE speed difference (especially when skipping svn).</p>

<div><script src='https://gist.github.com/4366220.js'></script>
<noscript><pre><code>#!/bin/bash
#requires gnu getopt
#requires rsync

GETOPT=&quot;/opt/local/bin/getopt&quot;
rsynccmd=&quot;rtlzv --exclude=compile --exclude=cache&quot;

localdir='/Volumes/Work/dev'
devdir='/home/username/dev'
devhost=&quot;dev&quot;

fromdev=0
nodelete=0
upfirst=0
withcustom=0
withsvn=0

tmp=`$GETOPT -o h?nRrs -l reverse,no-delete,help,dry-run:: -n $0 -- &quot;$@&quot;`

if [ $? != 0 ] ; then 
    echo $USAGE &gt;&amp;2 
    exit 1 
fi 

eval set -- &quot;$tmp&quot; 

# parse options 
while true; do  
    case $1 in
        -n|--dry-run )
            rsynccmd=&quot;n$rsynccmd&quot;
            shift;;
        --with-custom )
            withcustom=1
            shift;;
        --no-delete )
            nodelete=1
            shift;;
        -o|--config_override )
            override=1
            shift;;
        -R|-r|--reverse )
            fromdev=1
            shift;;
        -s|--svn )
            withsvn=1
            shift;;
        -- ) 
            shift
            break;; 
        * ) 
            echo $USAGE 
            exit 1;;
    esac
done

if [ $nodelete -eq 0 ]; then
    rsynccmd=&quot;$rsynccmd --delete&quot;
fi

if [ $withcustom -eq 0 ]; then
    rsynccmd=&quot;$rsynccmd --exclude=custom.ini&quot;
fi

if [ $withsvn -eq 0 ]; then
    rsynccmd=&quot;$rsynccmd --exclude=.svn&quot;
fi

if [ &quot;x$1&quot; == &quot;x&quot; ]; then
    if [ $fromdev -eq 0 ]; then
        echo rsync -$rsynccmd $localdir/ $devhost:$devdir/
        rsync -$rsynccmd $localdir/ $devhost:$devdir/
    else 
        echo rsync -$rsynccmd $devhost:$devdir/ $localdir/
        rsync -$rsynccmd $devhost:$devdir/ $localdir/
    fi
fi


while [ &quot;x$1&quot; != &quot;x&quot; ]; do
    dir=`echo $1 | tr '^' '/'`
    if [ $fromdev -eq 0 ]; then
         echo rsync -$rsynccmd $localdir/$dir/ $devhost:$devdir/$dir/
         rsync -$rsynccmd $localdir/$dir/ $devhost:$devdir/$dir/
    else
        echo rsync -$rsynccmd $devhost:$devdir/$dir/ $localdir/$dir/
        rsync -$rsynccmd $devhost:$devdir/$dir/ $localdir/$dir/
    fi

    shift
done</code></pre></noscript></div>


<p>Now for the actual ruby script using FSEvent. It also includes using growl to notify on synchronization events. While not required, it is nice to know when things are synched (and it lets me know the script is still running), but it can get a bit spammy (especially running svn up on a directory).</p>

<div><script src='https://gist.github.com/4366239.js'></script>
<noscript><pre><code>#!/usr/bin/env ruby
#requires osx fsevent
#requires growl with network registration enabled (at least once)
#requires the below rubygems
#requires rsync

require 'rubygems'
require 'rb-fsevent'
require 'ruby-growl'

local='/Volumes/Work/dev/'
remote='dev:/home/username/dev/'

# Decide on the local path.
Dir.mkdir(local) unless File.directory?(local)
local = File.expand_path(local)

# Parse the server and remote path.  Decide on the remote username.
raise unless remote =~ /^(?:([^@]+)@)?([^:]+):(.+)$/
    user, server, remote = $1, $2, $3
user ||= ENV[&quot;USER&quot;]

g = Growl.new(&quot;localhost&quot;, &quot;dirsync-monitor&quot;, [&quot;dirsync-monitor Push&quot;])
g.notify(&quot;dirsync-monitor Push&quot;, &quot;Watch Started&quot;, &quot;#{local} =&gt; #{remote}&quot;)

fsevent = FSEvent.new
fsevent.watch local do |directories|
    #$stderr.puts &quot;# detected change inside: #{directories.inspect}&quot;
    directories.each do |dir|
        pathname2 = &quot;#{dir.sub(local, &quot;&quot;)}&quot;
        #ignore some stuff
        if pathname2.match('/\.svn/.*$') != nil || 
            pathname2.match('/\.hg/.*$') != nil || 
            pathname2.match('/compile/$') != nil || 
            pathname2.match('/cache/$') != nil then
            next
        end
        l = &quot;#{local}#{pathname2}&quot;.gsub(' ', '\\\\ ')
        r =  &quot;#{user}@#{server}:#{remote}#{pathname2}&quot;.gsub(' ', '\\\\ ')

        cmd = &quot;rsync -tzplr --delete-after --exclude='/*/*' --exclude='custom.ini' --exclude='.svn' --exclude='.hg' --exclude='compile' --exclude='cache' --exclude='*.swp' #{l} #{r}&quot;
        #$stderr.puts cmd
        g.notify(&quot;dirsync-monitor Push&quot;, &quot;Sync&quot;, &quot;#{l} =&gt; #{r}&quot;)
        system(cmd)
    end
end
fsevent.run</code></pre></noscript></div>


<p>These scripts aren&rsquo;t perfect, and are meant to be modified to your own needs and preferences. Its so nice not to have to worry about manually syncing the directories anymore though!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Justin Hart</span></span>

      








  


<time datetime="2011-10-02T03:12:00-06:00" pubdate data-updated="true">Oct 2<span>nd</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/osx/'>osx</a>, <a class='category' href='/blog/categories/rsync/'>rsync</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
      
        <a class="basic-alignment right" href="/blog/2012/12/19/log-example-names-rspec/" title="Next Post: Log example names/descriptions from rspec">Log example names/descriptions from rspec &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>Justin Hart: Developer for <a href="https://twitter.com/ibottaapp">@ibottaapp</a>. Gamer, Geek, Coloradan.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/01/10/octopress/">'Octopress!'</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/18/rails-rest-api-versioning/">Rails REST API versioning</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/09/mp4box-fix-online-mp4s/">MP4Box can fix your online-hosted MP4s</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/07/rspec-cache-toggle/">Toggle Rails Caching in RSpec Suites</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/19/log-example-names-rspec/">Log example names/descriptions from rspec</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/onyxraven">@onyxraven</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'onyxraven',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("onyxraven", , );
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <p>Follow <a href="http://twitter.com/onyxraven">@onyxraven</a></p>
  
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Justin Hart -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
